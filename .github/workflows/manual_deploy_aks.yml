name: Manual Deploy/Fix - Azure AKS
# This workflow is focused SOLELY on Deployment.
# It can be triggered manually or could be configured to run after a successful CI run.

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image Tag to deploy (e.g., sha-12345 or latest)'
        required: true
        default: 'latest'

env:
  ACR_NAME: mlopsfraud
  RG: fraud-detection-rg
  CLUSTER: fraud-aks-cluster
  # Use the input tag if provided
  TAG: ${{ github.event.inputs.image_tag }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # 1. Login to Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # 2. Connect to AKS
      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ env.RG }}
          cluster-name: ${{ env.CLUSTER }}

      # 3. Create/Update Secrets in AKS (Syncing Github Secrets to Cluster)
      - name: Update App Secrets
        run: |
          kubectl create secret generic app-secrets \
            --from-literal=AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            --from-literal=AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            --from-literal=DAGSHUB_TOKEN=${{ secrets.DAGSHUB_TOKEN }} \
            --dry-run=client -o yaml | kubectl apply -f -

      # 4. Deploy Inference Service
      - name: Deploy Inference
        run: |
          # We use 'sed' to inject the specific image tag into the YAML before applying
          # This ensures we deploy EXACTLY the version requested
          sed -i "s|IMAGE_PLACEHOLDER|${{ env.ACR_NAME }}.azurecr.io/fraud-inference:${{ env.TAG }}|g" kubernetes/aks/inference.yaml
          
          kubectl apply -f kubernetes/aks/inference.yaml
          
          # Force a restart to ensure the new image is pulled immediately
          kubectl rollout restart deployment/inference-service

      # 5. Deploy Training Job
      - name: Deploy Training Job
        run: |
          sed -i "s|TRAINING_IMAGE_PLACEHOLDER|${{ env.ACR_NAME }}.azurecr.io/fraud-training:${{ env.TAG }}|g" kubernetes/aks/training.yaml
          kubectl apply -f kubernetes/aks/training.yaml
